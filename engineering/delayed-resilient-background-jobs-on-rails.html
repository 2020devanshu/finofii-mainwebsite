<!doctype html><html lang="en">
<!-- Mirrored from www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 30 Sep 2022 12:43:41 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head data-ipt="Introducing “Delayed”: Resilient Background Jobs on Rails">
    <meta charset="utf-8">
    <title>Introducing “Delayed”: Resilient Background Jobs on Rails</title>
    <link rel="shortcut icon" href="../hubfs/Graphics/shared-assets/Favicon-navy-circle.png">
    <meta name="description" content="How Betterment uses a multi-threaded, SQL-driven ActiveJob backend to process millions of background jobs per day.">
    
    
    

    <script>
      window.TT = "ewogICAgInNwbGl0cyI6e30sCiAgICAiZXhwZXJpZW5jZVNhbXBsaW5nV2VpZ2h0IjoxMDAsCiAgICAidXJsIjoiaHR0cHM6XC9cL3R0LmJldHRlcm1lbnQuY29tIiwKICAgICJjb29raWVEb21haW4iOiIuYmV0dGVybWVudC5jb20iLAogICAgImVuY29kZWRBdCI6IjIwMjEwNzEzMTU1MjAxIgp9"
    </script>
    
    
    
    <meta property="og:description" content="How Betterment uses a multi-threaded, SQL-driven ActiveJob backend to process millions of background jobs per day.">
    <meta property="og:title" content="Introducing “Delayed”: Resilient Background Jobs on Rails">
    <meta name="twitter:description" content="How Betterment uses a multi-threaded, SQL-driven ActiveJob backend to process millions of background jobs per day.">
    <meta name="twitter:title" content="Introducing “Delayed”: Resilient Background Jobs on Rails">

    

    
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails"
      },
      "headline": "Introducing “Delayed”: Resilient Background Jobs on Rails",
      "image": ["https://www.betterment.com/hubfs/Graphics/featured-images/portfolio-option-icons.png"],
      "datePublished": "Sep. 07, 2021",
      "dateModified": "Sep 7, 2021 12:00:00 AM",
      "author": {
          "@type": "Person",
          "name": "Nathan Griffith",
          "url": "www.betterment.com/engineering/author/nathan-griffith"
      },
      "publisher": {
        "@type": "Organization",
        "name": "Betterment",
        "logo": {
          "@type": "ImageObject",
          "url": "https://www.betterment.com/hubfs/Graphics/shared-assets/betterment-logo.png"
        }
      }
    }
  </script>
  
    <style>
a.cta_button{-moz-box-sizing:content-box !important;-webkit-box-sizing:content-box !important;box-sizing:content-box !important;vertical-align:middle}.hs-breadcrumb-menu{list-style-type:none;margin:0px 0px 0px 0px;padding:0px 0px 0px 0px}.hs-breadcrumb-menu-item{float:left;padding:10px 0px 10px 10px}.hs-breadcrumb-menu-divider:before{content:'›';padding-left:10px}.hs-featured-image-link{border:0}.hs-featured-image{float:right;margin:0 0 20px 20px;max-width:50%}@media (max-width: 568px){.hs-featured-image{float:none;margin:0;width:100%;max-width:100%}}.hs-screen-reader-text{clip:rect(1px, 1px, 1px, 1px);height:1px;overflow:hidden;position:absolute !important;width:1px}
</style>

<link rel="stylesheet" href="../hs-fs/hub/5274572/hub_generated/template_assets/49667076004/1664300040824/betterment-theme/css/main.min.css">
<link rel="stylesheet" href="../hs-fs/hub/5274572/hub_generated/template_assets/54140855578/1662668619796/betterment-theme/js/custom-scripts/navigation.min.css">
<link rel="stylesheet" href="../hs-fs/hub/5274572/hub_generated/module_assets/64614019605/1664467641345/module_64614019605_toast_banner_global.min.css">
<link rel="stylesheet" href="../hs-fs/hub/5274572/hub_generated/template_assets/57078106260/1657573877356/betterment-theme/templates/engineering_blog/blog.min.css">
<link rel="stylesheet" href="../hs-fs/hub/5274572/hub_generated/module_assets/55330962055/1664467632871/module_55330962055_blog_post_banner_cta.min.css">
<link rel="stylesheet" href="../hs-fs/hub/5274572/hub_generated/module_assets/53653099091/1664467639907/module_53653099091_social_share.min.css">
<link rel="stylesheet" href="../hs-fs/hub/5274572/hub_generated/module_assets/57076926612/1664467644356/module_57076926612_post_bottom_section.min.css">
<link rel="stylesheet" href="../hs-fs/hub/5274572/hub_generated/module_assets/53648998413/1664467636015/module_53648998413_footer_disclosures.min.css">
<link rel="stylesheet" href="../hs-fs/hub/5274572/hub_generated/template_assets/54140855579/1645062324227/betterment-theme/js/custom-scripts/footer.min.css">
    

    
<!--  Added by GoogleAnalytics integration -->
<script>
var _hsp = window._hsp = window._hsp || [];
_hsp.push(['addPrivacyConsentListener', function(consent) { if (consent.allowed || (consent.categories && consent.categories.analytics)) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','../../www.google-analytics.com/analytics.js','ga');
  ga('create','UA-10133968-1','auto');
  ga('send','pageview');
}}]);
</script>

<!-- /Added by GoogleAnalytics integration -->

<!--  Added by GoogleTagManager integration -->
<script>
var _hsp = window._hsp = window._hsp || [];

var hsLoadGtm = function loadGtm() {
    if(window._hsGtmLoadOnce) {
      return;
    }

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '../../www.googletagmanager.com/gtm5445.html?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5RSQL7');

    window._hsGtmLoadOnce = true;
};

var useGoogleConsentMode = true;

if (!useGoogleConsentMode){
    _hsp.push(['addPrivacyConsentListener', function(consent){
      if(consent.allowed || (consent.categories && consent.categories.analytics)){
        hsLoadGtm();
      }
  }]);
} else{
    if(!window._hsGoogleConsentRunOnce){
      window._hsGoogleConsentRunOnce=true;

      window.dataLayer=window.dataLayer||[];
      function gtag(){dataLayer.push(arguments);}

      gtag('consent','default',{
        'ad_storage':'denied',
        'analytics_storage':'denied'
      });

      gtag('set','developer_id.dZTQ1Zm',true);

      _hsp.push(['addPrivacyConsentListener',function(consent){
      var hasAnalyticsConsent=consent&&(consent.allowed||(consent.categories&&consent.categories.analytics));
      var hasAdsConsent=consent&&(consent.allowed||(consent.categories&&consent.categories.advertisement));

      gtag('consent','update',{
        'ad_storage':hasAdsConsent?'granted':'denied',
        'analytics_storage':hasAnalyticsConsent?'granted':'denied'
      });
    }]);
  }

  hsLoadGtm();
}
</script>

<!-- /Added by GoogleTagManager integration -->


<meta name="viewport" content="width=device-width, initial-scale=1">

<meta property="og:image" content="https://www.betterment.com/hubfs/Graphics/featured-images/portfolio-option-icons.png#keepProtocol">
<meta property="og:image:width" content="1100">
<meta property="og:image:height" content="550">
<meta property="og:image:alt" content="Various icons showing pie charts">
<meta name="twitter:image" content="https://www.betterment.com/hubfs/Graphics/featured-images/portfolio-option-icons.png#keepProtocol">
<meta name="twitter:image:alt" content="Various icons showing pie charts">

<meta property="og:url" content="https://www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails">
<meta name="twitter:card" content="summary_large_image">

<link rel="canonical" href="delayed-resilient-background-jobs-on-rails.html">

<meta property="og:type" content="article">
<link rel="alternate" type="application/rss+xml" href="rss.xml">
<meta name="twitter:domain" content="www.betterment.com">
<script src="../../platform.linkedin.com/in.js" type="text/javascript">
    lang: en_US
</script>

<meta http-equiv="content-language" content="en">






    
      
            
  <meta name="generator" content="HubSpot"></head>

  
  
    
    
    
  

  <body class="engineering_blog blog_post" data-contentid="57406541340" data-contentabid="">
<!--  Added by GoogleTagManager integration -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5RSQL7" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<!-- /Added by GoogleTagManager integration -->

    
    
    
    
    

    <div class="body-wrapper   hs-content-id-57406541340 hs-blog-post hs-blog-id-57138234906"> 
      
  


      

      
  
  
  <div class="bt-CourtesyNav bt-section bg-grey90 white">
    <div class="bt-container">
      <a href="#main-content" class="header__skip" data-interaction-listener-registered="true">Skip to main content</a>
      <div class="flex-wrap flex-middle u-flexJustifyEnd">
        
  
  
  <nav class="bt-CourtesyNav-list" data-behavior-large-screen-nav="" aria-label="courtesy navigation">
    <ul class="flex-wrap flex-middle u-flexJustifyEnd">
      
        
          <li id="menu-item-Individuals">
            <a href="../index.html" data-event="Individuals" data-track-event="ElementClicked" data-track-name="Individuals" data-track-module="CourtesyNav">Individuals</a>
          </li>
        
      
        
          <li id="menu-item-Employers">
            <a href="../work.html" data-event="Employers" data-track-event="ElementClicked" data-track-name="Employers" data-track-module="CourtesyNav">Employers</a>
          </li>
        
      
        
          <li id="menu-item-Advisors">
            <a href="../advisors.html" data-event="Advisors" data-track-event="ElementClicked" data-track-name="Advisors" data-track-module="CourtesyNav">Advisors</a>
          </li>
        
      
    </ul>
  </nav>

      </div>
    </div>
  </div>

  <div class="nav-header-wrap">
    <div class="nav-header-wrap-children">
      <div id="hs_cos_wrapper_module_1633637126" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module">

<div class="bt-Nav-wrap careers-nav">
      
  

  
  
  
    
    
  
    
    
      
      
      
      
    
  
    
    
      
      
      
      
    
  
    
    
      
      
        
            
          
            
            
          
        
        
            
          
            
            
          
        
        
      
      
      
    
  
    
    
  
    
    
  
  
  <header>
    <div class="bt-Nav bt-section ptb0  ">
      <div class="bt-container">
        <div class="flex-wrap flex-middle">
    
          
          <a href="../index.html" class="bt-Nav-logoContainer" data-track-event="ElementClicked" data-track-name="Logo" data-track-module="TopNav" data-interaction-listener-registered="true">
            <span class="bt-Logo"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 538 74" aria-label="Betterment Logo" role="img" ">
  <title>Betterment Logo</title>
  <path d="M489.013 23.5871C486.234 23.5506 483.488 24.2211 481.019 25.5394C478.55 26.8577 476.432 28.7834 474.853 31.1468V24.8723H463.886V67.4286H474.853V46.5996C474.853 38.5952 478.533 33.8193 484.696 33.8193C490.128 33.8193 494.015 37.5369 494.015 43.7491V67.4286H504.9V41.3701C504.904 30.2529 498.409 23.5871 489.013 23.5871Z" />
  <path d="M380.618 67.3975H369.05V43.7204C369.05 37.8734 365.39 33.7916 360.139 33.7916C353.585 33.7916 349.674 38.567 349.674 46.5705V67.3975H338.014V24.8588H349.674V31.146C351.351 28.7827 353.6 26.857 356.224 25.5387C358.848 24.2204 361.765 23.5502 364.718 23.5872C371.405 23.5872 376.451 26.9308 378.925 32.5689C380.68 29.7955 383.143 27.5108 386.075 25.9369C389.007 24.363 392.308 23.5535 395.657 23.5872C405.318 23.5872 411.557 30.5636 411.557 41.3727V67.4286H399.994V43.7515C399.994 37.9045 396.334 33.8228 391.079 33.8228C384.529 33.8228 380.613 38.5982 380.613 46.6017L380.618 67.3975Z" />
  <path d="M143.033 38.7458L140.543 37.7475L142.924 36.5319C143.203 36.3899 149.575 32.9826 149.575 24.7837C149.575 17.8626 143.423 10.8571 131.662 10.8571H103.243V67.4286H131.717C150.386 67.4286 151.329 54.6111 151.329 52.0423C151.333 42.193 143.116 38.7857 143.033 38.7458ZM114.999 20.1652H129.048C132.903 20.1652 137.055 22.4145 137.055 27.3614C137.055 32.1884 133.026 34.7173 129.048 34.7173H114.999V20.1652ZM130.888 58.1205H114.999V43.5684H130.888C136.093 43.5684 138.813 47.2685 138.813 50.9287C138.813 55.1036 135.48 58.1294 130.888 58.1294V58.1205Z" />
  <path d="M199.414 46.2299C199.161 32.9014 189.991 23.5857 177.106 23.5857C164.026 23.5857 154.159 33.3165 154.159 46.221C154.082 52.127 156.323 57.8338 160.414 62.1474C164.596 66.4726 170.593 68.8429 177.115 68.8429C183.637 68.8429 189.634 66.4637 193.816 62.1474C196.063 59.8026 197.763 57.0007 198.794 53.9387H188.226C186.063 57.7372 181.985 60.0405 177.115 60.0405C171.507 60.0405 166.981 56.108 165.737 50.024L165.433 48.551H199.414V46.2299ZM166.053 40.7887C166.727 38.4138 168.174 36.3234 170.171 34.84C172.169 33.3565 174.605 32.5624 177.106 32.58C182.379 32.58 186.321 35.651 187.697 40.7887H166.053Z" />
  <path d="M304.071 46.2299C303.826 32.9014 294.944 23.5857 282.462 23.5857C269.788 23.5857 260.23 33.3165 260.23 46.221C260.158 52.1266 262.328 57.8325 266.289 62.1474C270.34 66.4726 276.149 68.8429 282.471 68.8429C288.793 68.8429 294.597 66.4637 298.648 62.1474C300.825 59.8026 302.472 57.0007 303.471 53.9387H293.221C291.125 57.7372 287.171 60.0405 282.458 60.0405C277.026 60.0405 272.642 56.108 271.436 50.024L271.142 48.551H304.058L304.071 46.2299ZM271.752 40.7887C272.405 38.4135 273.807 36.323 275.743 34.8395C277.679 33.3561 280.04 32.5621 282.462 32.58C287.57 32.58 291.388 35.651 292.721 40.7887H271.752Z" />
  <path d="M458.229 46.2299C457.983 32.9014 449.1 23.5857 436.617 23.5857C423.941 23.5857 414.388 33.3165 414.388 46.221C414.313 52.126 416.482 57.8321 420.443 62.1474C424.498 66.4726 430.308 68.8429 436.626 68.8429C442.944 68.8429 448.754 66.4637 452.805 62.1474C454.982 59.8026 456.629 57.0007 457.628 53.9387H447.377C445.281 57.7372 441.331 60.0405 436.613 60.0405C431.18 60.0405 426.796 56.108 425.59 50.024L425.296 48.551H458.229V46.2299ZM425.91 40.7887C426.562 38.4135 427.964 36.3226 429.899 34.839C431.834 33.3555 434.195 32.5616 436.617 32.58C441.725 32.58 445.544 35.651 446.877 40.7887H425.91Z" />
  <path d="M335.186 23.6276C327.992 23.1829 321.875 26.296 318.779 32.193V24.8684H306.9V67.4286H318.779V48.9503C318.779 37.6632 326.892 31.9039 335.186 35.1371V23.6276Z" />
  <path d="M258.883 58.1735C257.211 58.9069 255.405 59.2878 253.578 59.2922C248.532 59.2922 245.75 56.2304 245.75 50.6685V33.6217H259.383V24.9268H245.741V6.61875L234.363 10.75V24.9268H215.035V6.61429L203.657 10.7456V52.1927C203.657 63.0848 209.315 68.8429 220.015 68.8429C224.19 68.8429 227.771 68.1699 230.929 66.7839L228.169 58.1825C226.496 58.9159 224.69 59.2967 222.864 59.3011C217.818 59.3011 215.035 56.2394 215.035 50.6774V33.6351H234.371V52.1927C234.371 63.0848 240.029 68.8429 250.733 68.8429C254.904 68.8429 258.486 68.1699 261.643 66.7839L258.883 58.1735Z" />
  <path d="M534.709 58.1691C533.063 58.9024 531.285 59.2832 529.486 59.2877C524.51 59.2877 521.773 56.226 521.773 50.6641V33.6173H535.202V24.9223H521.769V6.61429L510.557 10.7456V52.1927C510.557 63.0848 516.132 68.8429 526.679 68.8429C530.793 68.8429 534.322 68.1699 537.429 66.7839L534.709 58.1691Z" />
  <path d="M45.2571 60.232L81.2004 73.0857C87.0869 65.5936 90.5143 56.0542 90.5143 45.4144C90.5143 20.071 71.061 0.957146 45.2571 0.957146C19.4533 0.957146 0 20.071 0 45.4144C0 56.0542 3.43189 65.5805 9.31831 73.0857L45.2571 60.232Z" fill="#FFC729" />
</svg></span>
          </a>
    
          
          <div class="bt-Nav-triggerCta" data-behavior-toggle-class="is-expanded" data-toggle-target=".bt-OverlayPanel" data-behavior-overlay-nav-trigger="" role="button" tabindex="0" data-cy-overlaynavcta="">
            <span class="">
              <span class="bt-Icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" aria-label="Open menu" role="img">
                  <title>Open menu</title>
                  <path id="for-open" d="M0 9V7h16v2H0zm0-4V3h16v2H0zm0 8v-2h16v2H0z"></path>
                  <path id="for-close" d="M14.6 0L8 6.6 1.4 0 0 1.4 6.6 8 0 14.6 1.4 16 8 9.4l6.6 6.6 1.4-1.4L9.4 8 16 1.4 14.6 0z"></path>
                </svg>
              </span>
            </span>
          </div>
    
          <div class="nav-wrap flex-wrap flex-middle">
            
            <nav class="HeaderNavWp__nav" data-behavior-large-screen-nav="" aria-label="header navigation">
              <div class="menu-new_menu-container">
                <ul class="menu flex-wrap flex-middle">
                
                  <li id="menu-item-27c7b8732d1a279720d27cc8c3a26c93" class="menu-item menu-item_depth-1   menu-item-27c7b8732d1a279720d27cc8c3a26c93">
                    
                      <a href="../careers.html" data-event="Careers" data-track-event="ElementClicked" data-track-name="Careers
" data-track-module="TopNav">Careers</a>
                    
                    
                    
                    
    
                  </li>
                
                  <li id="menu-item-ab0268fb8036a892dc341945cb7ae3be" class="menu-item menu-item_depth-1   menu-item-ab0268fb8036a892dc341945cb7ae3be">
                    
                      <a href="../careers/engineering.html" data-event="Engineering" data-track-event="ElementClicked" data-track-name="Engineering
" data-track-module="TopNav">Engineering</a>
                    
                    
                    
                    
    
                  </li>
                
                  <li id="menu-item-d6b9ea32b921a9f56de32062ba4b94f3" class="menu-item menu-item_depth-1 current-menu-ancestor current-menu-parent menu-item-has-children menu-item-d6b9ea32b921a9f56de32062ba4b94f3">
                    
                      <a data-event="Blogs" data-track-event="ElementClicked" data-track-name="Blogs
" data-track-module="TopNav" role="button" tabindex="0" aria-controls="menu-control-2" aria-expanded="false">Blogs</a>
                    
                    
                    
                    
                    <ul class="sub-menu" id="menu-control-2">
                      
                      <li id="menu-item-6ee2fe1fca2b4136a53b06e70b70a361" class="menu-item menu-item_depth-2  menu-item-6ee2fe1fca2b4136a53b06e70b70a361">
                        <a href="../design.html" data-event="Product and design blog" data-track-event="ElementClicked" data-track-name="ProductAndDesignBlog
" data-track-module="TopNav" data-itemindex="0">Product and design blog</a>
                      </li>
                      
                      <li id="menu-item-3d3a360f13403f3fbacdfc8d597e8f62" class="menu-item menu-item_depth-2 current-menu-ancestor current-menu-parent menu-item-3d3a360f13403f3fbacdfc8d597e8f62">
                        <a href="../engineering.html" data-event="Engineering blog" data-track-event="ElementClicked" data-track-name="EngineeringBlog
" data-track-module="TopNav" data-itemindex="1">Engineering blog</a>
                      </li>
                      
                    </ul>
                    
    
                  </li>
                
                </ul>
              </div>
            </nav>
            
   
  
      
  
  
  <div class="bt-Nav-panelTrigger bt-nav-cta-1">
    <div class="u-displayNone--until-lg">
      <div>
        <a href="../about.html" class="HeaderNavWp__LoginButton" data-cy-nav-large-secondary-cta="" data-track-event="ElementClicked" data-track-name="LogIn" data-track-module="TopNav" data-interaction-listener-registered="true">
          About us
        </a>
      </div>
    </div>
  </div>
  



  
      
  
  
  <div class="u-displayNone--until-lg bt-nav-cta-2">
    <div>
      <a href="../careers/current-openings.html" class="bt-PrimaryButton" data-cy-nav-large-primary-cta="" data-behavior-get-started-click="" data-get-started-click-location="TopNav">
          Explore openings
      </a>
    </div>      
  </div>
   


            
  
  
  <nav class="bt-CourtesyNav-list" data-behavior-large-screen-nav="" aria-label="courtesy navigation mobile">
    <ul>
      
        
          <li id="menu-item-Individuals">
            <a href="../index.html" data-event="Individuals" data-track-event="ElementClicked" data-track-name="Individuals" data-track-module="CourtesyNav" class="bt-eyebrow">For Individuals</a>
          </li>
        
      
        
          <li id="menu-item-Employers">
            <a href="../work.html" data-event="Employers" data-track-event="ElementClicked" data-track-name="Employers" data-track-module="CourtesyNav" class="bt-eyebrow">For Employers</a>
          </li>
        
      
        
          <li id="menu-item-Advisors">
            <a href="../advisors.html" data-event="Advisors" data-track-event="ElementClicked" data-track-name="Advisors" data-track-module="CourtesyNav" class="bt-eyebrow">For Advisors</a>
          </li>
        
      
    </ul>
  </nav>

          </div>
    
        </div>
      </div>
    </div>
  </header>

  
 
</div>

</div>
      
      <div id="hs_cos_wrapper_module_16419355051849" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module">





   
      
   
      
      <script id="hero-spacing-script" type="application/json">{"pt_lg":120,"pt_sm":100}</script>
   





   

   

   

</div>
    </div>
  </div>

  
      
 

                  








<main id="main-content" class="body-container-wrapper read-time blog-post">
  <div class="body-container body-container--blog-post">
    
    <article>
      <div class="bt-section hero-spacer">
        <div class="see-all-articles">
          <div class="bt-container">
            <a href="../engineering.html" class="bt-TertiaryButton bt-TertiaryButton_reverse">See all articles</a>
          </div>
        </div>
        <div class="bt-container bt-container_small">
          <div class="blog-post-header">
            <h1 class="bt-title2">Introducing “Delayed”: Resilient Background Jobs on Rails</h1>

            
            <h2 class="bt-body1">In the past 24 hours, a Ruby on Rails application at Betterment performed somewhere on the order of 10 million asynchronous tasks.</h2>
            
            

            <div class="blog-post-meta flex flex-middle">
            
              <img class="author-thumbnail" src="../hubfs/Graphics/author-avatars/nathan-griffith.jpg" alt="Image of Nathan Griffith | Senior Staff Engineer, Betterment">
            

              <div class="blog-post-meta-text bt-body3">
                <span class="blog-post-meta-text-top">
                  By
                  
                    <a href="author/nathan-griffith.html" rel="author">Nathan Griffith</a>
                  
                </span>
                <div class="blog-post-meta-text-bottom">
                  
                    <span>Senior Staff Engineer, Betterment</span>
                  
                  
                    <span> | </span>
                  
                  
   
     
   
 
   
 
   <div class="blog-post-date">
     <span>Published <time datetime="2021-09-07" class="blog-post-timestamp">Sep. 07, 2021</time> </span>
 
     
   </div>

                </div>
              </div>
            </div>
          </div>
        </div>

        
          <div class="bt-container bt-container_narrow center">
            <img class="blog-post-featured-image" src="../hubfs/Graphics/featured-images/portfolio-option-icons.png" alt="Various icons showing pie charts">      
          </div>
        

        <div class="bt-container bt-container_small">
          <div class="blog-post-caption-area">
            <div class="flex flex-spaceBetween blog-post-meta-2">
              <div class="js-post-body-count" aria-hidden="true" hidden>
              Introducing “Delayed”: Resilient Background Jobs on Rails Sep 7, 2021 12:00:00 AM In the past 24 hours, a Ruby on Rails application at Betterment performed somewhere on the order of 10 million asynchronous tasks. While many of these tasks merely sent a transactional email, or fired off an iOS or Android push notification, plenty involved the actual movement of money—deposits, withdrawals, transfers, rollovers, you name it—while others kept Betterment’s information systems up-to-date—syncing customers’ linked account information, logging events to downstream data consumers, the list goes on. What all of these tasks had in common (aside from being, well, really important to our business) is that they were executed via a database-backed job-execution framework called Delayed, a newly-open-sourced library that we’re excited to announce… right now, as part of this blog post! And, yes, you heard that right. We run millions of these so-called “background jobs” daily using a SQL-backed queue—not Redis, or RabbitMQ, or Kafka, or, um, you get the point—and we’ve very intentionally made this choice, for reasons that will soon be explained! But first, let’s back up a little and answer a few basic questions. Why Background Jobs? In other words, what purpose do these background jobs serve? And how does running millions of them per day help us? Well, when building web applications, we (as web application developers) strive to build pages that respond quickly and reliably to web requests. One might say that this is the primary goal of any webapp—to provide a set of HTTP endpoints that reliably handle all the success and failure cases within a specified amount of time, and that don’t topple over under high-traffic conditions. This is made possible, at least in part, by the ability to perform units of work asynchronously. In our case, via background jobs. At Betterment, we rely on said jobs extensively, to limit the amount of work performed during the “critical path” of each web request, and also to perform scheduled tasks at regular intervals. Our reliance on background jobs even allows us to guarantee the eventual consistency of our distributed systems, but more on that later. First, let’s take a look at the underlying framework we use for enqueuing and executing said jobs. Frameworks Galore! And, boy howdy, are there plenty of available frameworks for doing this kind of thing! Ruby on Rails developers have the choice of resque, sidekiq, que, good_job, delayed_job, and now... delayed, Betterment’s own flavor of job queue! Thankfully, Rails provides an abstraction layer on top of these, in the form of the Active Job framework. This, in theory, means that all jobs can be written in more or less the same way, regardless of the job-execution backend. Write some jobs, pick a queue backend with a few desirable features (priorities, queues, etc), run some job worker processes, and we’re off to the races! Sounds simple enough! Unfortunately, if it were so simple we wouldn’t be here, several paragraphs into a blog post on the topic. In practice, deciding on a job queue is more complicated than that. Quite a bit more complicated, because each backend framework provides its own set of trade-offs and guarantees, many of which will have far-reaching implications in our codebase. So we’ll need to consider carefully! How To Choose A Job Framework The delayed rubygem is a fork of both delayed_job and delayed_job activerecord, with several targeted changes and additions, including numerous performance &amp; scalability optimizations that we’ll cover towards the end of this post. But first, in order to explain how Betterment arrived where we did, we must explain what it is that we need our job queue to be capable of, starting with the jobs themselves. You see, a background job essentially represents a tiny contract. Each consists of some action being taken for / by / on behalf of / in the interest of one or more of our customers, and that must be completed within an appropriate amount of time. Betterment’s engineers decided, therefore, that it was critical to our mission that we be capable of handling each and every contract as reliably as possible. In other words, every job we attempt to enqueue must, eventually, reach some form of resolution. Of course, job “resolution” doesn’t necessarily mean success. Plenty of jobs may complete in failure, or simply fail to complete, and may require some form of automated or manual intervention. But the point is that jobs are never simply dropped, or silently deleted, or lost to the cyber-aether, at any point, from the moment we enqueue them to their eventual resolution. This general property—the ability to enqueue jobs safely and ensure their eventual resolution—is the core feature that we have optimized for. Let’s call it resilience. Optimizing For Resilience Now, you might be thinking, shouldn’t all of these ActiveJob backends be, at the very least, safe to use? Isn’t “resilience” a basic feature of every backend, except maybe the test/development ones? And, yeah, it’s a fair question. As the author of this post, my tactful attempt at an answer is that, well, not all queue backends optimize for the specific kind of end-to-end resilience that we look for. Namely, the guarantee of at-least-once execution. Granted, having “exactly-once” semantics would be preferable, but if we cannot be sure that our jobs run at least once, then we must ask ourselves: how would we know if something didn’t run at all? What kind of monitoring would be necessary to detect such a failure, across all the features of our app, and all the types of jobs it might try to run? These questions open up an entirely different can of worms, one that we would prefer remained firmly sealed. Remember, jobs are contracts. A web request was made, code was executed, and by enqueuing a job, we said we'd eventually do something. Not doing it would be... bad. Not even knowing we didn't do it... very bad. So, at the very least, we need the guarantee of at-least-once execution. Building on at-least-once guarantees If we know for sure that we’ll fully execute all jobs at least once, then we can write our jobs in such a way that makes the at-least-once approach reliable and resilient to failure. Specifically, we’ll want to make our jobs idempotent—basically, safely retryable, or resumable—and that is on us as application developers to ensure on a case-by-case basis. Once we solve this very solvable idempotency problem, then we’re on track for the same net result as an “exactly-once” approach, even if it takes a couple extra attempts to get there. Furthermore, this combination of at-least-once execution and idempotency can then be used in a distributed systems context, to ensure the eventual consistency of changes across multiple apps and databases. Whenever a change occurs in one system, we can enqueue idempotent jobs notifying the other systems, and retry them until they succeed, or until we are left with stuck jobs that must be addressed operationally. We still concern ourselves with other distributed systems pitfalls like event ordering, but we don’t have to worry about messages or events disappearing without a trace due to infrastructure blips. So, suffice it to say, at-least-once semantics are crucial in more ways than one, and not all ActiveJob backends provide them. Redis-based queues, for example, can only be as durable (the “D” in “ACID”) as the underlying datastore, and most Redis deployments intentionally trade-off some durability for speed and availability. Plus, even when running in the most durable mode, Redis-based ActiveJob backends tend to dequeue jobs before they are executed, meaning that if a worker process crashes at the wrong moment, or is terminated during a code deployment, the job is lost. These frameworks have recently begun to move away from this LPOP-based approach, in favor of using RPOPLPUSH (to atomically move jobs to a queue that can then be monitored for orphaned jobs), but outside of Sidekiq Pro, this strategy doesn’t yet seem to be broadly available. And these job execution guarantees aren’t the only area where a background queue might fail to be resilient. Another big resilience failure happens far earlier, during the enqueue step. Enqueues and Transactions See, there’s a major “gotcha” that may not be obvious from the list of ActiveJob backends. Specifically, it’s that some queues rely on an app’s primary database connection—they are “database-backed,” against the app’s own database—whereas others rely on a separate datastore, like Redis. And therein lies the rub, because whether or not our job queue is colocated with our application data will greatly inform the way that we write any job-adjacent code. More precisely, when we make use of database transactions (which, when we use ActiveRecord, we assuredly do whether we realize it or not), a database-backed queue will ensure that enqueued jobs will either commit or roll back with the rest of our ActiveRecord-based changes. This is extremely convenient, to say the least, since most jobs are enqueued as part of operations that persist other changes to our database, and we can in turn rely on the all-or-nothing nature of transactions to ensure that neither the job nor the data mutation is persisted without the other. Meanwhile, if our queue existed in a separate datastore, our enqueues will be completely unaware of the transaction, and we’d run the risk of enqueuing a job that acts on data that was never committed, or (even worse) we’d fail to enqueue a job even when the rest of the transactional data was committed. This would fundamentally undermine our at-least-once execution guarantees! We already use ACID-compliant datastores to solve these precise kinds of data persistence issues, so with the exception of really, really high volume operations (where a lot of noise and data loss can—or must—be tolerated), there’s really no reason not to enqueue jobs co-transactionally with other data changes. And this is precisely why, at Betterment, we start each application off with a database-backed queue, co-located with the rest of the app’s data, with the guarantee of at-least-once job execution. By the way, this is a topic I could talk about endlessly, so I’ll leave it there for now. If you’re interested in hearing me say even more about resilient data persistence and job execution, feel free to check out Can I break this?, a talk I gave at RailsConf 2021! But in addition to the resiliency guarantees outlined above, we’ve also given a lot of attention to the operability and the scalability of our queue. Let’s cover operability first. Maintaining a Queue in the Long Run Operating a queue means being able to respond to errors and recover from failures, and also being generally able to tell when things are falling behind. (Essentially, it means keeping our on-call engineers happy.) We do this in two ways: with dashboards, and with alerts. Our dashboards come in a few parts. Firstly, we host a private fork of delayedjobweb, a web UI that allows us to see the state of our queues in real time and drill down to specific jobs. We’ve extended the gem with information on “erroring” jobs (jobs that are in the process of retrying but have not yet permanently failed), as well as the ability to filter by additional fields such as job name, priority, and the owning team (which we store in an additional column). We also maintain two other dashboards in our cloud monitoring service, DataDog. These are powered by instrumentation and continuous monitoring features that we have added directly to the delayed gem itself. When jobs run, they emit ActiveSupport::Notification events that we subscribe to and then forward along to a StatsD emitter, typically as “distribution” or “increment” metrics. Additionally, we’ve included a continuous monitoring process that runs aggregate queries, tagged and grouped by queue and priority, and that emits similar notifications that become “gauge” metrics. Once all of these metrics make it to DataDog, we’re able to display a comprehensive timeboard that graphs things like average job runtime, throughput, time spent waiting in the queue, error rates, pickup query performance, and even some top 10 lists of slowest and most erroring jobs. On the alerting side, we have DataDog monitors in place for overall queue statistics, like max age SLA violations, so that we can alert and page ourselves when queues aren’t working off jobs quickly enough. Our SLAs are actually defined on a per-priority basis, and we’ve added a feature to the delayed gem called “named priorities” that allows us to define priority-specific configs. These represent integer ranges (entirely orthogonal to queues), and default to “interactive” (0-9), “user visible” (10-19), “eventual” (20-29), and “reporting” (30+), with default alerting thresholds focused on retry attempts and runtime. There are plenty of other features that we’ve built that haven’t made it into the delayed gem quite yet. These include the ability for apps to share a job queue but run separate workers (i.e. multi-tenancy), team-level job ownership annotations, resumable bulk orchestration and batch enqueuing of millions of jobs at once, forward-scheduled job throttling, and also the ability to encrypt the inputs to jobs so that they aren’t visible in plaintext in the database. Any of these might be the topic for a future post, and might someday make their way upstream into a public release! But Does It Scale? As we've grown, we've had to push at the limits of what a database-backed queue can accomplish. We’ve baked several improvements into the delayed gem, including a highly optimized, SKIP LOCKED-based pickup query, multithreaded workers, and a novel “max percent of max age” metric that we use to automatically scale our worker pool up to ~3x its baseline size when queues need additional concurrency. Eventually, we could explore ways of feeding jobs through to higher performance queues downstream, far away from the database-backed workers. We already do something like this for some jobs with our journaled gem, which uses AWS Kinesis to funnel event payloads out to our data warehouse (while at the same time benefiting from the same at-least-once delivery guarantees as our other jobs!). Perhaps we’d want to generalize the approach even further. But the reality of even a fully "scaled up" queue solution is that, if it is doing anything particularly interesting, it is likely to be database-bound. A Redis-based queue will still introduce DB pressure if its jobs execute anything involving ActiveRecord models, and solutions must exist to throttle or rate limit these jobs. So even if your queue lives in an entirely separate datastore, it can be effectively coupled to your DB's IOPS and CPU limitations. So does the delayed approach scale? To answer that question, I’ll leave you with one last takeaway. A nice property that we’ve observed at Betterment, and that might apply to you as well, is that the number of jobs tends to scale proportionally with the number of customers and accounts. This means that when we naturally hit vertical scaling limits, we could, for example, shard or partition our job table alongside our users table. Then, instead of operating one giant queue, we’ll have broken things down to a number of smaller queues, each with their own worker pools, emitting metrics that can be aggregated with almost the same observability story we have today. But we’re getting into pretty uncharted territory here, and, as always, your mileage may vary! Try it out! If you’ve read this far, we’d encourage you to take the leap and test out the delayed gem for yourself! Again, it combines both DelayedJob and its ActiveRecord backend, and should be more or less compatible with Rails apps that already use ActiveJob or DelayedJob. Of course, it may require a bit of tuning on your part, and we’d love to hear how it goes! We’ve also built an equivalent library in Java, which may also see a public release at some point. (To any Java devs reading this: let us know if that interests you!) Already tried it out? Any features you’d like to see added? Let us know what you think!
              </div>
              <span class="readingTime"></span>
              <div id="hs_cos_wrapper_module_1629497677" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module">

<div class="social-container">
   
      
   <span id="hs_cos_wrapper_module_1629497677_my_social_sharing" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_social_sharing" style="" data-hs-cos-general-type="widget" data-hs-cos-type="social_sharing"></span>
   
   <ul class="flex flex-middle social-items"> 
      
         <li>
            <a href="http://www.facebook.com/share.php?u=https://www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails?utm_medium%3Dsocial%26utm_source%3Demail" target="_blank" rel="noopener noreferrer">
               <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" aria-label="Betterment on Facebook" role="img"><title>Betterment on Facebook</title><path d="M9.5 3H12V0H9.5C7.5 0 6 1.6 6 3.5V5H4v3h2v8h3V8h2.5l.5-3H9V3.5c0-.3.2-.5.5-.5"></path></svg>
            </a>
         </li>
      
         <li>
            <a href="https://twitter.com/intent/tweet?original_referer=https://www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails?utm_medium%3Dsocial%26utm_source%3Demail&amp;url=https://www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails?utm_medium%3Dsocial%26utm_source%3Demail&amp;source=tweetbutton&amp;text=Introducing+%E2%80%9CDelayed%E2%80%9D%3A+Resilient+Background+Jobs+on+Rails" target="_blank" rel="noopener noreferrer">
               <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" aria-label="Betterment on Twitter" role="img"> <title>Betterment on Twitter</title> <path d="M16 2.7c-.6.3-1.2.5-1.9.5.7-.4 1.2-1 1.5-1.8a6 6 0 01-2.1.8 3.3 3.3 0 00-5.6 3A9.3 9.3 0 011 1.8a3.3 3.3 0 001 4.4c-.5 0-1-.2-1.5-.4 0 1.6 1.2 3 2.7 3.2a3.3 3.3 0 01-1.5 0 3.3 3.3 0 003 2.4A6.6 6.6 0 010 12.7a9.3 9.3 0 0014.4-8.3c.6-.4 1.2-1 1.6-1.7"></path> </svg>
            </a>
         </li>
      
         <li>
            <a href="mailto:?subject=Check%20out%20https://www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails?utm_medium%3Dsocial%26utm_source%3Demail%20&amp;body=Check%20out%20https://www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails?utm_medium%3Dsocial%26utm_source%3Demail" target="_blank" rel="noopener noreferrer">
               <svg viewbox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-label="Betterment Email Share"><title>Betterment Email Share</title><path fill-rule="evenodd" clip-rule="evenodd" d="M1 4H16V15H1V4ZM2.5 13.4286V7.53571L8.5 11.4643L14.5 7.53571V13.4286H2.5ZM14.5 5.57143H2.5L8.5 9.5L14.5 5.57143Z" /></svg>
            </a>
         </li>
      

      
         <li class="copy-clip-container">
            <button aria-label="Copy Post Link" class="bt-UnstyledButton copy-clip-button">
               <svg viewbox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-label="Betterment Clipboard Share"><title>Betterment Clipboard Share</title><path fill-rule="evenodd" clip-rule="evenodd" d="M2.53333 5.13332C2.83406 4.82896 3.19221 4.58731 3.58703 4.42238C3.98184 4.25746 4.40546 4.17253 4.83333 4.17253C5.26121 4.17253 5.68483 4.25746 6.07964 4.42238C6.47445 4.58731 6.8326 4.82896 7.13333 5.13332L9.03333 7.03332L8.2 7.86666L6.3 5.96666C5.89446 5.64917 5.38639 5.49179 4.87239 5.52443C4.35839 5.55707 3.87432 5.77746 3.5122 6.1437C3.15008 6.50993 2.93517 6.99647 2.90834 7.5108C2.88151 8.02514 3.04462 8.5314 3.36667 8.93332L5.26667 10.8L4.43333 11.6333L2.53333 9.73332C2.22897 9.43259 1.98732 9.07444 1.82239 8.67963C1.65746 8.28482 1.57254 7.8612 1.57254 7.43332C1.57254 7.00545 1.65746 6.58183 1.82239 6.18702C1.98732 5.79221 2.22897 5.43405 2.53333 5.13332V5.13332Z" /> <path fill-rule="evenodd" clip-rule="evenodd" d="M11.8667 14.4667C12.4733 13.8549 12.8136 13.0282 12.8136 12.1667C12.8136 11.3051 12.4733 10.4785 11.8667 9.86666L9.96667 7.96666L9.13334 8.79999L11.0333 10.7C11.4223 11.089 11.6408 11.6166 11.6408 12.1667C11.6408 12.7168 11.4223 13.2443 11.0333 13.6333C10.6444 14.0223 10.1168 14.2408 9.56667 14.2408C9.01656 14.2408 8.48899 14.0223 8.1 13.6333L6.2 11.7333L5.36667 12.5667L7.26667 14.4667C7.87847 15.0733 8.70513 15.4136 9.56667 15.4136C10.4282 15.4136 11.2549 15.0733 11.8667 14.4667V14.4667Z" /> <path fill-rule="evenodd" clip-rule="evenodd" d="M9.13334 12.5667L4.43333 7.86667L5.26667 7.03334L9.96667 11.7333L9.13334 12.5667V12.5667Z" /></svg>
            </button>
            <div class="copy-clip-confirmation">
               <p>Copied!</p>
            </div>
         </li>
      
   </ul>
   
</div>

</div>
            </div>
          </div>
        </div>

        <div class="bt-container bt-container_small">
          <div class="blog-post-body">
            <span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" style="" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><!--more-->
<p>While many of these tasks merely sent a transactional email, or fired off an iOS or Android push notification, plenty involved the actual movement of money—deposits, withdrawals, transfers, rollovers, you name it—while others kept Betterment’s information systems up-to-date—syncing customers’ linked account information, logging events to downstream data consumers, the list goes on.</p>
<p>What all of these tasks had in common (aside from being, well, really important to our business) is that they were executed via a <em>database-backed</em> job-execution framework called <a href="https://github.com/Betterment/delayed">Delayed</a>, a newly-open-sourced library that we’re excited to announce… right now, as part of this blog post!</p>
<p>And, yes, you heard that right. We run millions of these so-called “background jobs” daily using a <em>SQL-backed</em> queue—not Redis, or RabbitMQ, or Kafka, or, um, you get the point—and we’ve very intentionally made this choice, for reasons that will soon be explained! But first, let’s back up a little and answer a few basic questions.</p>
<h2>Why Background Jobs?</h2>
<p>In other words, what purpose do these background jobs serve? And how does running millions of them per day help us?</p>
<p>Well, when building web applications, we (as web application developers) strive to build pages that respond quickly and reliably to web requests. One might say that this is the primary goal of <em>any</em> webapp—to provide a set of HTTP endpoints that reliably handle all the success and failure cases within a specified amount of time, and that don’t topple over under high-traffic conditions.</p>
<p>This is made possible, at least in part, by the ability to perform units of work <em>asynchronously</em>. In our case, via background jobs. At Betterment, we rely on said jobs extensively, to limit the amount of work performed during the “critical path” of each web request, and also to perform scheduled tasks at regular intervals. Our reliance on background jobs even allows us to guarantee the eventual consistency of our distributed systems, but more on that later. First, let’s take a look at the underlying framework we use for enqueuing and executing said jobs.</p>
<h2>Frameworks Galore!</h2>
<p>And, boy howdy, are there plenty of available frameworks for doing this kind of thing! Ruby on Rails developers have the choice of <a href="https://github.com/resque/resque">resque</a>, <a href="https://github.com/mperham/sidekiq">sidekiq</a>, <a href="https://github.com/que-rb/que">que</a>, <a href="https://github.com/bensheldon/good_job">good_job</a>, <a href="https://github.com/collectiveidea/delayed_job">delayed</a><a href="https://github.com/collectiveidea/delayed_job">_job</a>, and now... <a href="https://github.com/Betterment/delayed">delayed</a>, Betterment’s own flavor of job queue!</p>
<p>Thankfully, Rails provides an abstraction layer on top of these, in the form of the <a href="https://guides.rubyonrails.org/active_job_basics.html">Active Job framework</a>. This, in theory, means that all jobs can be written in more or less the same way, regardless of the job-execution backend. Write some jobs, pick a queue backend with a few desirable features (priorities, queues, etc), run some job worker processes, and we’re off to the races! Sounds simple enough!</p>
<p>Unfortunately, if it were so simple we wouldn’t be here, several paragraphs into a blog post on the topic. In practice, deciding on a job queue is more complicated than that. Quite a bit more complicated, because each backend framework provides its own set of trade-offs and guarantees, many of which will have far-reaching implications in our codebase. So we’ll need to consider carefully!</p>
<h2>How To Choose A Job Framework</h2>
<p>The <a href="https://github.com/Betterment/delayed">delayed</a> rubygem is a fork of both <a href="https://github.com/collectiveidea/delayed_job">delayed_job</a> and <a href="https://github.com/collectiveidea/delayed_job_active_record">delayed</a><a href="https://github.com/collectiveidea/delayed_job_active_record">_job activerecord</a>, with several targeted changes and additions, including numerous performance &amp; scalability optimizations that we’ll cover towards the end of this post. But first, in order to explain how Betterment arrived where we did, we must explain what it is that we need our job queue to be capable of, starting with the jobs themselves.</p>
<p>You see, a background job essentially represents a tiny contract. Each consists of some action being taken for / by / on behalf of / in the interest of one or more of our customers, and that must be completed within an appropriate amount of time. Betterment’s engineers decided, therefore, that it was critical to our mission that we be capable of handling each and every contract as reliably as possible. In other words, every job we attempt to enqueue must, eventually, reach some form of resolution.</p>
<p>Of course, job “resolution” doesn’t necessarily mean success. Plenty of jobs may complete in failure, or simply fail to complete, and may require some form of automated or manual intervention. But the point is that jobs are <em>never</em> simply dropped, or silently deleted, or lost to the cyber-aether, at any point, from the moment we enqueue them to their eventual resolution.</p>
<p>This general property—the ability to enqueue jobs safely and ensure their eventual resolution—is the core feature that we have optimized for. Let’s call it <strong>resilience.</strong></p>
<h2>Optimizing For Resilience</h2>
<p>Now, you might be thinking, shouldn’t <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveJob/QueueAdapters.html">all of these ActiveJob backends</a> be, at the very least, safe to use? Isn’t “resilience” a basic feature of every backend, except maybe the test/development ones? And, yeah, it’s a fair question. As the author of this post, my tactful attempt at an answer is that, well, not all queue backends optimize for the specific kind of end-to-end resilience that we look for. Namely, the guarantee of <strong>at-least-once execution.</strong></p>
<p>Granted, having “exactly-once” semantics would be preferable, but if we cannot be sure that our jobs run <em>at least</em> once, then we must ask ourselves: how would we know if something didn’t run at all? What kind of monitoring would be necessary to detect such a failure, across all the features of our app, and all the types of jobs it might try to run? These questions open up an entirely different can of worms, one that we would prefer remained firmly sealed.</p>
<p>Remember, jobs are contracts. A web request was made, code was executed, and by enqueuing a job, we said we'd eventually do something. Not doing it would be... bad. Not even <em>knowing</em> we didn't do it... very bad. So, at the very least, we need the guarantee of at-least-once execution.</p>
<h2>Building on at-least-once guarantees</h2>
<p>If we know for sure that we’ll fully execute all jobs at least once, then we can write our jobs in such a way that makes the at-least-once approach reliable and resilient to failure. Specifically, we’ll want to make our jobs <strong>idempotent</strong>—basically, safely retryable, or resumable—and that is on us as application developers to ensure on a case-by-case basis. Once we solve this very solvable idempotency problem, then we’re on track for the same net result as an “exactly-once” approach, even if it takes a couple extra attempts to get there.</p>
<p>Furthermore, this combination of at-least-once execution and idempotency can then be used in a distributed systems context, to ensure the eventual consistency of changes across multiple apps and databases. Whenever a change occurs in one system, we can enqueue idempotent jobs notifying the other systems, and retry them until they succeed, or until we are left with stuck jobs that must be addressed operationally. We still concern ourselves with other distributed systems pitfalls like event ordering, but we don’t have to worry about messages or events disappearing without a trace due to infrastructure blips.</p>
<p>So, suffice it to say, at-least-once semantics are crucial in more ways than one, and not all ActiveJob backends provide them. Redis-based queues, for example, can only be as durable (the “D” in “<a href="https://en.wikipedia.org/wiki/ACID">ACID</a>”) as the underlying datastore, and most Redis deployments intentionally trade-off some durability for speed and availability. Plus, even when running in the most durable mode, Redis-based ActiveJob backends tend to dequeue jobs <em>before</em> they are executed, meaning that if a worker process crashes at the wrong moment, or is terminated during a code deployment, the job is lost. These frameworks have recently begun to move away from this <a href="https://redis.io/commands/LPOP">LPOP</a>-based approach, in favor of using <a href="https://redis.io/commands/RPOPLPUSH">RPOPLPUSH</a> (to atomically move jobs to a queue that can then be monitored for orphaned jobs), but outside of Sidekiq Pro, this strategy doesn’t yet seem to be broadly available.</p>
<p>And these job execution guarantees aren’t the only area where a background queue might fail to be resilient. Another big resilience failure happens far earlier, during the <em>enqueue</em> step.</p>
<h2>Enqueues and Transactions</h2>
<p>See, there’s a major “gotcha” that may not be obvious from the list of ActiveJob backends. Specifically, it’s that some queues rely on an app’s primary database connection—they are “database-backed,” against the app’s own database—whereas others rely on a separate datastore, like Redis. And therein lies the rub, because whether or not our job queue is colocated with our application data will greatly inform the way that we write any job-adjacent code.</p>
<p>More precisely, when we make use of database transactions (which, when we use ActiveRecord, we assuredly do whether we realize it or not), a database-backed queue will ensure that enqueued jobs will either commit or roll back with the rest of our ActiveRecord-based changes. This is <em>extremely</em> convenient, to say the least, since most jobs are enqueued as part of operations that persist other changes to our database, and we can in turn rely on the all-or-nothing nature of transactions to ensure that neither the job nor the data mutation is persisted without the other.</p>
<p>Meanwhile, if our queue existed in a separate datastore, our enqueues will be completely unaware of the transaction, and we’d run the risk of enqueuing a job that acts on data that was never committed, or (even worse) we’d fail to enqueue a job even when the rest of the transactional data was committed. This would fundamentally undermine our at-least-once execution guarantees!</p>
<p>We already use <a href="https://en.wikipedia.org/wiki/ACID">ACID</a>-compliant datastores to solve these precise kinds of data persistence issues, so with the exception of really, really high volume operations (where a lot of noise and data loss can—or must—be tolerated), there’s really no reason not to enqueue jobs co-transactionally with other data changes. And this is precisely why, at Betterment, we start each application off with a database-backed queue, co-located with the rest of the app’s data, with the guarantee of at-least-once job execution.</p>
<p>By the way, this is a topic I could talk about <em>endlessly</em>, so I’ll leave it there for now. If you’re interested in hearing me say even more about resilient data persistence and job execution, feel free to check out <em><a href="https://www.youtube.com/watch?v=TuhS13rBoVY">Can I break this?</a>,</em> a talk I gave at RailsConf 2021! But in addition to the resiliency guarantees outlined above, we’ve also given a lot of attention to the <strong>operability</strong> and the <strong>scalability</strong> of our queue. Let’s cover operability first.</p>
<h2>Maintaining a Queue in the Long Run</h2>
<p>Operating a queue means being able to respond to errors and recover from failures, and also being generally able to tell when things are falling behind. (Essentially, it means keeping our on-call engineers happy.) We do this in two ways: with <strong>dashboards</strong>, and with <strong>alerts</strong>.</p>
<p>Our dashboards come in a few parts. Firstly, we host a private fork of <a href="https://github.com/ejschmitt/delayed_job_web">delayed<em>job</em>web</a>, a web UI that allows us to see the state of our queues in real time and drill down to specific jobs. We’ve extended the gem with information on “erroring” jobs (jobs that are in the process of retrying but have not yet permanently failed), as well as the ability to filter by additional fields such as job name, priority, and the owning team (which we store in an additional column).</p>
<p>We also maintain two other dashboards in our cloud monitoring service, DataDog. These are powered by instrumentation and continuous monitoring features that we have added directly to the <a href="https://github.com/Betterment/delayed">delayed</a> gem itself. When jobs run, they emit ActiveSupport::Notification events that we subscribe to and then forward along to a StatsD emitter, typically as “distribution” or “increment” metrics. Additionally, we’ve included a continuous monitoring process that runs aggregate queries, tagged and grouped by queue and priority, and that emits similar notifications that become “gauge” metrics. Once all of these metrics make it to DataDog, we’re able to display a comprehensive timeboard that graphs things like average job runtime, throughput, time spent waiting in the queue, error rates, pickup query performance, and even some top 10 lists of slowest and most erroring jobs.</p>
<p>On the alerting side, we have DataDog monitors in place for overall queue statistics, like max age SLA violations, so that we can alert and page ourselves when queues aren’t working off jobs quickly enough. Our SLAs are actually defined on a per-priority basis, and we’ve added a feature to the <a href="https://github.com/Betterment/delayed">delayed</a> gem called “named priorities” that allows us to define priority-specific configs. These represent integer ranges (entirely orthogonal to queues), and default to “interactive” (0-9), “user visible” (10-19), “eventual” (20-29), and “reporting” (30+), with default alerting thresholds focused on retry attempts and runtime.</p>
<p>There are plenty of other features that we’ve built that haven’t made it into the <a href="https://github.com/Betterment/delayed">delayed</a> gem quite yet. These include the ability for apps to share a job queue but run separate workers (i.e. multi-tenancy), team-level job ownership annotations, resumable bulk orchestration and batch enqueuing of millions of jobs at once, forward-scheduled job throttling, and also the ability to encrypt the inputs to jobs so that they aren’t visible in plaintext in the database. Any of these might be the topic for a future post, and might someday make their way upstream into a public release!</p>
<h2>But Does It Scale?</h2>
<p>As we've grown, we've had to push at the limits of what a database-backed queue can accomplish. We’ve baked several improvements into the <a href="https://github.com/Betterment/delayed">delayed</a> gem, including a highly optimized, SKIP LOCKED-based pickup query, multithreaded workers, and a novel “max percent of max age” metric that we use to automatically scale our worker pool up to ~3x its baseline size when queues need additional concurrency.</p>
<p>Eventually, we could explore ways of feeding jobs through to higher performance queues downstream, far away from the database-backed workers. We already do something like this for some jobs with our <a href="https://github.com/Betterment/journaled">journaled</a> gem, which uses AWS Kinesis to funnel event payloads out to our data warehouse (while at the same time benefiting from the same at-least-once delivery guarantees as our other jobs!). Perhaps we’d want to generalize the approach even further.</p>
<p>But the reality of even a fully "scaled up" queue solution is that, if it is doing anything particularly interesting, it is likely to be database-bound. A Redis-based queue will still introduce DB pressure if its jobs execute anything involving ActiveRecord models, and solutions must exist to throttle or rate limit these jobs. So even if your queue lives in an entirely separate datastore, it can be effectively coupled to your DB's IOPS and CPU limitations.</p>
<p>So does the <a href="https://github.com/Betterment/delayed">delayed</a> approach scale?</p>
<p>To answer that question, I’ll leave you with one last takeaway. A nice property that we’ve observed at Betterment, and that might apply to you as well, is that the number of jobs tends to scale proportionally with the number of customers and accounts. This means that when we naturally hit vertical scaling limits, we could, for example, shard or partition our job table alongside our users table. Then, instead of operating one giant queue, we’ll have broken things down to a number of smaller queues, each with their own worker pools, emitting metrics that can be aggregated with almost the same observability story we have today. But we’re getting into pretty uncharted territory here, and, as always, your mileage may vary!</p>
<h2>Try it out!</h2>
<p>If you’ve read this far, we’d encourage you to take the leap and test out the <a href="https://github.com/Betterment/delayed">delayed</a> gem for yourself! Again, it combines both DelayedJob and its ActiveRecord backend, and should be more or less compatible with Rails apps that already use ActiveJob or DelayedJob. Of course, it may require a bit of tuning on your part, and we’d love to hear how it goes! We’ve also built an equivalent library in Java, which may also see a public release at some point. (To any Java devs reading this: let us know if that interests you!)</p>
<p>Already tried it out? Any features you’d like to see added? <a href="https://github.com/Betterment/delayed/issues">Let us know</a> what you think!</p></span>
          </div>
        </div>

        




        <div class="bt-container bt-container_small">
          <div id="hs_cos_wrapper_module_1629497677" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module">

<div class="social-container">
   
      
   <span id="hs_cos_wrapper_module_1629497677_my_social_sharing" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_social_sharing" style="" data-hs-cos-general-type="widget" data-hs-cos-type="social_sharing"></span>
   
   <ul class="flex flex-middle social-items"> 
      
         <li>
            <a href="http://www.facebook.com/share.php?u=https://www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails?utm_medium%3Dsocial%26utm_source%3Demail" target="_blank" rel="noopener noreferrer">
               <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" aria-label="Betterment on Facebook" role="img"><title>Betterment on Facebook</title><path d="M9.5 3H12V0H9.5C7.5 0 6 1.6 6 3.5V5H4v3h2v8h3V8h2.5l.5-3H9V3.5c0-.3.2-.5.5-.5"></path></svg>
            </a>
         </li>
      
         <li>
            <a href="https://twitter.com/intent/tweet?original_referer=https://www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails?utm_medium%3Dsocial%26utm_source%3Demail&amp;url=https://www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails?utm_medium%3Dsocial%26utm_source%3Demail&amp;source=tweetbutton&amp;text=Introducing+%E2%80%9CDelayed%E2%80%9D%3A+Resilient+Background+Jobs+on+Rails" target="_blank" rel="noopener noreferrer">
               <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" aria-label="Betterment on Twitter" role="img"> <title>Betterment on Twitter</title> <path d="M16 2.7c-.6.3-1.2.5-1.9.5.7-.4 1.2-1 1.5-1.8a6 6 0 01-2.1.8 3.3 3.3 0 00-5.6 3A9.3 9.3 0 011 1.8a3.3 3.3 0 001 4.4c-.5 0-1-.2-1.5-.4 0 1.6 1.2 3 2.7 3.2a3.3 3.3 0 01-1.5 0 3.3 3.3 0 003 2.4A6.6 6.6 0 010 12.7a9.3 9.3 0 0014.4-8.3c.6-.4 1.2-1 1.6-1.7"></path> </svg>
            </a>
         </li>
      
         <li>
            <a href="mailto:?subject=Check%20out%20https://www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails?utm_medium%3Dsocial%26utm_source%3Demail%20&amp;body=Check%20out%20https://www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails?utm_medium%3Dsocial%26utm_source%3Demail" target="_blank" rel="noopener noreferrer">
               <svg viewbox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-label="Betterment Email Share"><title>Betterment Email Share</title><path fill-rule="evenodd" clip-rule="evenodd" d="M1 4H16V15H1V4ZM2.5 13.4286V7.53571L8.5 11.4643L14.5 7.53571V13.4286H2.5ZM14.5 5.57143H2.5L8.5 9.5L14.5 5.57143Z" /></svg>
            </a>
         </li>
      

      
         <li class="copy-clip-container">
            <button aria-label="Copy Post Link" class="bt-UnstyledButton copy-clip-button">
               <svg viewbox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-label="Betterment Clipboard Share"><title>Betterment Clipboard Share</title><path fill-rule="evenodd" clip-rule="evenodd" d="M2.53333 5.13332C2.83406 4.82896 3.19221 4.58731 3.58703 4.42238C3.98184 4.25746 4.40546 4.17253 4.83333 4.17253C5.26121 4.17253 5.68483 4.25746 6.07964 4.42238C6.47445 4.58731 6.8326 4.82896 7.13333 5.13332L9.03333 7.03332L8.2 7.86666L6.3 5.96666C5.89446 5.64917 5.38639 5.49179 4.87239 5.52443C4.35839 5.55707 3.87432 5.77746 3.5122 6.1437C3.15008 6.50993 2.93517 6.99647 2.90834 7.5108C2.88151 8.02514 3.04462 8.5314 3.36667 8.93332L5.26667 10.8L4.43333 11.6333L2.53333 9.73332C2.22897 9.43259 1.98732 9.07444 1.82239 8.67963C1.65746 8.28482 1.57254 7.8612 1.57254 7.43332C1.57254 7.00545 1.65746 6.58183 1.82239 6.18702C1.98732 5.79221 2.22897 5.43405 2.53333 5.13332V5.13332Z" /> <path fill-rule="evenodd" clip-rule="evenodd" d="M11.8667 14.4667C12.4733 13.8549 12.8136 13.0282 12.8136 12.1667C12.8136 11.3051 12.4733 10.4785 11.8667 9.86666L9.96667 7.96666L9.13334 8.79999L11.0333 10.7C11.4223 11.089 11.6408 11.6166 11.6408 12.1667C11.6408 12.7168 11.4223 13.2443 11.0333 13.6333C10.6444 14.0223 10.1168 14.2408 9.56667 14.2408C9.01656 14.2408 8.48899 14.0223 8.1 13.6333L6.2 11.7333L5.36667 12.5667L7.26667 14.4667C7.87847 15.0733 8.70513 15.4136 9.56667 15.4136C10.4282 15.4136 11.2549 15.0733 11.8667 14.4667V14.4667Z" /> <path fill-rule="evenodd" clip-rule="evenodd" d="M9.13334 12.5667L4.43333 7.86667L5.26667 7.03334L9.96667 11.7333L9.13334 12.5667V12.5667Z" /></svg>
            </button>
            <div class="copy-clip-confirmation">
               <p>Copied!</p>
            </div>
         </li>
      
   </ul>
   
</div>

</div>
        </div>
      </div>
    </article>
  </div>
</main>




  
  
    
      
    
  
    
  
  
  


  
   
      
  <footer class="bt-section footer bg-navy white">
    <div class="bt-container">
      <div id="hs_cos_wrapper_module_16267052898241" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module">

  
    
    
      
    
  
      
    
      
      
                    
          
                    
          
                    
          
                    
          
                    
          
                    
          
        
      
      
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
      
      
                    
          
                    
          
                    
          
                    
          
                    
          
                    
          
        
      
      
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
      
      
                    
          
                    
          
                    
          
                    
          
                    
          
                    
          
        
      
      
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
      
      
                    
          
                    
          
                    
          
                    
          
                    
          
                    
          
                    
          
        
      
      
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
      
      
                    
          
                    
          
                    
          
                    
          
                    
          
                    
          
                    
          
                    
          
        
      
      
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  
      
    
  


  <div class="footer-main-columns u-flex u-flexJustifyBetween">
    <div class="footer-logo-wrapper">
      <svg viewbox="0 0 91 74" width="35" height="29" xmlns="http://www.w3.org/2000/svg" fill="none">
        <title>Betterment Logo Icon SVG Footer</title>
        <path d="M45.2571 60.0478C53.6288 63.0794 68.2782 68.3853 81.1967 73.0658C87.083 65.4792 90.5143 55.8131 90.5143 45.0369C90.5143 19.3603 71.0593 0 45.2571 0C19.4571 0 0 19.3603 0 45.0369C0 55.8153 3.42913 65.4792 9.31758 73.0658C22.26 68.3788 36.9311 63.0643 45.2571 60.0478Z" fill="#FFC729" />
      </svg>
    </div>
  
    
    <nav class="footer-menu-wrapper" aria-label="footer navigation">
      <ul>
      
        <li class="footer-menu_column footer-menu_column-0">
          
            <div class="footer-menu-title">Accounts</div>
          

          
          <ul>
          
            <li>
              <a class="footer__menu__item" href="../investing.html" target="" data-track-event="ElementClicked" data-track-name="Investing" data-track-module="Footer" data-interaction-listener-registered="true">Investing</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../ira-and-401k.html" target="" data-track-event="ElementClicked" data-track-name="IRAs and 401(k)s" data-track-module="Footer" data-interaction-listener-registered="true">IRAs and 401(k)s</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../roth-ira.html" target="" data-track-event="ElementClicked" data-track-name="Roth IRAs" data-track-module="Footer" data-interaction-listener-registered="true">Roth IRAs</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../cash-reserve.html" target="" data-track-event="ElementClicked" data-track-name="Cash Reserve" data-track-module="Footer" data-interaction-listener-registered="true">Cash Reserve</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../checking.html" target="" data-track-event="ElementClicked" data-track-name="Checking" data-track-module="Footer" data-interaction-listener-registered="true">Checking</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../trust-accounts.html" target="" data-track-event="ElementClicked" data-track-name="Trusts" data-track-module="Footer" data-interaction-listener-registered="true">Trusts</a>
            </li>
            
          </ul>
          
        </li>
      
        <li class="footer-menu_column footer-menu_column-1">
          
            <div class="footer-menu-title">Investments</div>
          

          
          <ul>
          
            <li>
              <a class="footer__menu__item" href="../investments.html" target="" data-track-event="ElementClicked" data-track-name="Portfolio options" data-track-module="Footer" data-interaction-listener-registered="true">Portfolio options</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../socially-responsible-investing.html" target="" data-track-event="ElementClicked" data-track-name="Socially responsible investing" data-track-module="Footer" data-interaction-listener-registered="true">Socially responsible investing</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../tax-efficient-investing.html" target="" data-track-event="ElementClicked" data-track-name="Tax-smart investing" data-track-module="Footer" data-interaction-listener-registered="true">Tax-smart investing</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../charitable-giving/index.html" target="" data-track-event="ElementClicked" data-track-name="Charitable giving" data-track-module="Footer" data-interaction-listener-registered="true">Charitable giving</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../rollover.html" target="" data-track-event="ElementClicked" data-track-name="401(k) rollovers" data-track-module="Footer" data-interaction-listener-registered="true">401(k) rollovers</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../retirement-income.html" target="" data-track-event="ElementClicked" data-track-name="Retirement income" data-track-module="Footer" data-interaction-listener-registered="true">Retirement income</a>
            </li>
            
          </ul>
          
        </li>
      
        <li class="footer-menu_column footer-menu_column-2">
          
            <div class="footer-menu-title">Tools</div>
          

          
          <ul>
          
            <li>
              <a class="footer__menu__item" href="../retirement.html" target="" data-track-event="ElementClicked" data-track-name="Retirement planning" data-track-module="Footer" data-interaction-listener-registered="true">Retirement planning</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../goals.html" target="" data-track-event="ElementClicked" data-track-name="Track your goals" data-track-module="Footer" data-interaction-listener-registered="true">Track your goals</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../dashboard.html" target="" data-track-event="ElementClicked" data-track-name="All-in-one dashboard" data-track-module="Footer" data-interaction-listener-registered="true">All-in-one dashboard</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../robo-advisor.html" target="" data-track-event="ElementClicked" data-track-name="Compare robo-advisors" data-track-module="Footer" data-interaction-listener-registered="true">Compare robo-advisors</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../rewards.html" target="" data-track-event="ElementClicked" data-track-name="Rewards" data-track-module="Footer" data-interaction-listener-registered="true">Rewards</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../referral.html" target="" data-track-event="ElementClicked" data-track-name="Refer-a-friend program" data-track-module="Footer" data-interaction-listener-registered="true">Refer-a-friend program</a>
            </li>
            
          </ul>
          
        </li>
      
        <li class="footer-menu_column footer-menu_column-3">
          
            <div class="footer-menu-title">Help</div>
          

          
          <ul>
          
            <li>
              <a class="footer__menu__item" href="../help.html" target="" data-track-event="ElementClicked" data-track-name="Help center" data-track-module="Footer" data-interaction-listener-registered="true">Help center</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../help/tag/common-questions.html" target="" data-track-event="ElementClicked" data-track-name="FAQ" data-track-module="Footer" data-interaction-listener-registered="true">FAQ</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../financial-experts.html" target="" data-track-event="ElementClicked" data-track-name="Expert guidance" data-track-module="Footer" data-interaction-listener-registered="true">Expert guidance</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../resources/how-robo-advisors-guide-your-investing.html" target="" data-track-event="ElementClicked" data-track-name="Investment philosophy" data-track-module="Footer" data-interaction-listener-registered="true">Investment philosophy</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../resources.html" target="" data-track-event="ElementClicked" data-track-name="Article library" data-track-module="Footer" data-interaction-listener-registered="true">Article library</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../resources/video.html" target="" data-track-event="ElementClicked" data-track-name="Video" data-track-module="Footer" data-interaction-listener-registered="true">Video</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../legal.html" target="" data-track-event="ElementClicked" data-track-name="Legal" data-track-module="Footer" data-interaction-listener-registered="true">Legal</a>
            </li>
            
          </ul>
          
        </li>
      
        <li class="footer-menu_column footer-menu_column-4">
          
            <div class="footer-menu-title">Company</div>
          

          
          <ul>
          
            <li>
              <a class="footer__menu__item" href="../pricing.html" target="" data-track-event="ElementClicked" data-track-name="Pricing" data-track-module="Footer" data-interaction-listener-registered="true">Pricing</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../about.html" target="" data-track-event="ElementClicked" data-track-name="About us" data-track-module="Footer" data-interaction-listener-registered="true">About us</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../mobile-app.html" target="" data-track-event="ElementClicked" data-track-name="Mobile app" data-track-module="Footer" data-interaction-listener-registered="true">Mobile app</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../how-it-works.html" target="" data-track-event="ElementClicked" data-track-name="How Betterment works" data-track-module="Footer" data-interaction-listener-registered="true">How Betterment works</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../roadmap.html" target="" data-track-event="ElementClicked" data-track-name="Product roadmap" data-track-module="Footer" data-interaction-listener-registered="true">Product roadmap</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../press.html" target="" data-track-event="ElementClicked" data-track-name="Press" data-track-module="Footer" data-interaction-listener-registered="true">Press</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="https://shop.betterment.com/" target="" data-track-event="ElementClicked" data-track-name="Betterment shop" data-track-module="Footer" data-interaction-listener-registered="true">Betterment shop</a>
            </li>
            
            <li>
              <a class="footer__menu__item" href="../careers.html" target="" data-track-event="ElementClicked" data-track-name="Careers" data-track-module="Footer" data-interaction-listener-registered="true">Careers</a>
            </li>
            
          </ul>
          
        </li>
      
      </ul>
    </nav>
    
  </div>

  <div class="footer-bottom-menu">
    <div class="footer-social-icons">
      <ul class="flex">
        <li>
          <a href="https://www.instagram.com/betterment/" target="_blank" rel="noopener noreferrer"><svg aria-label="Betterment on Instagram" width="24" height="24" viewbox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"> <title>Betterment on Instagram</title> <path d="M12 2.163C15.204 2.163 15.584 2.175 16.85 2.233C20.102 2.381 21.621 3.924 21.769 7.152C21.827 8.417 21.838 8.797 21.838 12.001C21.838 15.206 21.826 15.585 21.769 16.85C21.62 20.075 20.105 21.621 16.85 21.769C15.584 21.827 15.206 21.839 12 21.839C8.796 21.839 8.416 21.827 7.151 21.769C3.891 21.62 2.38 20.07 2.232 16.849C2.174 15.584 2.162 15.205 2.162 12C2.162 8.796 2.175 8.417 2.232 7.151C2.381 3.924 3.896 2.38 7.151 2.232C8.417 2.175 8.796 2.163 12 2.163ZM12 0C8.741 0 8.333 0.014 7.053 0.072C2.695 0.272 0.273 2.69 0.073 7.052C0.014 8.333 0 8.741 0 12C0 15.259 0.014 15.668 0.072 16.948C0.272 21.306 2.69 23.728 7.052 23.928C8.333 23.986 8.741 24 12 24C15.259 24 15.668 23.986 16.948 23.928C21.302 23.728 23.73 21.31 23.927 16.948C23.986 15.668 24 15.259 24 12C24 8.741 23.986 8.333 23.928 7.053C23.732 2.699 21.311 0.273 16.949 0.073C15.668 0.014 15.259 0 12 0V0ZM12 5.838C8.597 5.838 5.838 8.597 5.838 12C5.838 15.403 8.597 18.163 12 18.163C15.403 18.163 18.162 15.404 18.162 12C18.162 8.597 15.403 5.838 12 5.838ZM12 16C9.791 16 8 14.21 8 12C8 9.791 9.791 8 12 8C14.209 8 16 9.791 16 12C16 14.21 14.209 16 12 16ZM18.406 4.155C17.61 4.155 16.965 4.8 16.965 5.595C16.965 6.39 17.61 7.035 18.406 7.035C19.201 7.035 19.845 6.39 19.845 5.595C19.845 4.8 19.201 4.155 18.406 4.155Z" fill="currentColor"></path> </svg></a>
        </li>
        <li>
          <a href="http://facebook.com/betterment" target="_blank" rel="noopener noreferrer"><svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" aria-label="Betterment on Facebook" role="img"><title>Betterment on Facebook</title><path d="M9.5 3H12V0H9.5C7.5 0 6 1.6 6 3.5V5H4v3h2v8h3V8h2.5l.5-3H9V3.5c0-.3.2-.5.5-.5"></path></svg></a>
        </li>
        <li>
          <a href="http://twitter.com/betterment" target="_blank" rel="noopener noreferrer"><svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" aria-label="Betterment on Twitter" role="img"> <title>Betterment on Twitter</title> <path d="M16 2.7c-.6.3-1.2.5-1.9.5.7-.4 1.2-1 1.5-1.8a6 6 0 01-2.1.8 3.3 3.3 0 00-5.6 3A9.3 9.3 0 011 1.8a3.3 3.3 0 001 4.4c-.5 0-1-.2-1.5-.4 0 1.6 1.2 3 2.7 3.2a3.3 3.3 0 01-1.5 0 3.3 3.3 0 003 2.4A6.6 6.6 0 010 12.7a9.3 9.3 0 0014.4-8.3c.6-.4 1.2-1 1.6-1.7"></path> </svg></a>
        </li>
        <li>
          <a href="http://www.linkedin.com/company/betterment" target="_blank" rel="noopener noreferrer"><svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" aria-label="Betterment on LinkedIn" role="img"> <title>Betterment on LinkedIn</title> <path d="M.2 15.2h3.4V4.9H.2v10.3zM1.9 0C.8 0 0 .8 0 1.8s.7 1.8 1.9 1.8 2-.8 2-1.8S3 0 1.9 0zM16 9.3v5.9h-3.4V9.7c0-1.4-.5-2.3-1.8-2.3-1 0-1.5.6-1.7 1.2l-.1.9v5.7H5.5V4.9H9v1.5c.4-.7 1.2-1.7 3-1.7 2.3 0 4 1.5 4 4.6z"></path> </svg></a>
        </li>
      </ul>
    </div>

    
      <div class="footer-apps-icons">
        <ul class="flex">
          
            <li>
              <a class="track-ios-click" href="https://apps.apple.com/us/app/betterment-money-management/id393156562" target="_blank" rel="noopener noreferrer" data-behavior-app-store-link="" data-cy-apple-store-link="" data-appsflyer-source="retailBrochureFooter" data-track-event="AppStoreSelected" data-track-name="DownloadIOSAppStore" data-track-module="Footer">
                <img class="lazy" data-src="https://www.betterment.com/hubfs/Graphics/shared-assets/app-store-badge_wht-bdr.svg" alt="apple-app-store">
              </a>
            </li>
          
          
            <li>
              <a class="track-google-play-click" href="https://play.google.com/store/apps/details?id=com.betterment" target="_blank" rel="noopener noreferrer" data-behavior-app-store-link="" data-cy-android-store-link="" data-android-store-link data-appsflyer-source="retailBrochureFooter" data-track-event="AppStoreSelected" data-track-name="DownloadGooglePlay" data-track-module="Footer">
                <img class="lazy" data-src="https://www.betterment.com/hubfs/Graphics/shared-assets/google-play-badge-wht-bdr.svg" alt="google-play-store">
              </a>
            </li>
        
        </ul>
      </div>
    


    
    <div class="footer-bottom-links">
    
      <ul class="flex">
        
          
            
            
            
            

          <li>
            <a href="../contact.html" data-track-event="ElementClicked" data-track-name="Contact us" data-track-module="Footer" data-interaction-listener-registered="true">Contact us</a>
          </li>
        
          
            
            
            
            

          <li>
            <a href="../work.html" data-track-event="ElementClicked" data-track-name="Betterment 401(k)" data-track-module="Footer" data-interaction-listener-registered="true">Betterment 401(k)</a>
          </li>
        
          
            
            
            
            

          <li>
            <a href="../advisors.html" data-track-event="ElementClicked" data-track-name="Betterment for Advisors" data-track-module="Footer" data-interaction-listener-registered="true">Betterment for Advisors</a>
          </li>
        
      </ul>
    
    </div>


  </div>

</div>

      <div id="hs_cos_wrapper_module_16301570831873" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module" style="" data-hs-cos-general-type="widget" data-hs-cos-type="module"> 

 
  

  
  
  
  
    
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
  
  <div class="footer-disclosure-wrap">
    
  
  
    
   
    
      <div class="footer-disclosure-rows entity-disclosure"><p>This page is operated and maintained by Betterment Holdings Inc. and it is not associated with Betterment LLC or MTG LLC. © 2021 Betterment Holdings Inc.</p></div>
    
  
    <div class="footer-disclosure-rows">
      
  
<div>
  <p> You are viewing a web property located at Betterment.com. Different properties may be provided by a different entity with different marketing standards. </p>
  
  
  <ul class="flex-wrap list-links">
    
    <li>
      <a href="../sitemap.html">Site Map</a>
    </li>
  
    
    <li>
      <a href="../legal/terms.html">Terms of Use</a>
    </li>
  
    
    <li>
      <a href="../legal/privacy-policy.html">Privacy Policy</a>
    </li>
  
    
    <li>
      <a href="../legal/copyright-intellectual-property.html">Trademark</a>
    </li>
  
    
    <li>
      <a href="../legal.html">Legal Directory</a>
    </li>
  
  </ul>

  <p>Google Play and the Google Play logo are trademarks of Google, Inc.</p>
  <p>Apple, the Apple logo, and iPhone are trademarks of Apple, Inc., registered in the U.S.</p>
  <p>Any links provided to other websites are offered as a matter of convenience and are not intended to imply that Betterment or its authors endorse, sponsor, promote, and/or are affiliated with the owners of or participants in those sites, unless stated otherwise.</p>
  <p>© Betterment. All rights reserved</p>
</div>


    </div>
  </div></div> 
    </div> 
  </footer>  

    </div>
    
    
    
    
    
<script>
(function () {
    window.addEventListener('load', function () {
        setTimeout(function () {
            var xhr = new XMLHttpRequest();
            xhr.open('POST.html', '/_hcms/perf', true /*async*/);
            xhr.setRequestHeader("Content-type", "application/json");
            xhr.onreadystatechange = function () {
                // do nothing.
            };
            var connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            function populateNetworkInfo(name, connection, info) {
                if (name in connection) {
                    info[name] = connection[name];
                }
            }
            var networkInfo = {};
            if (connection) {
                ['type', 'effectiveType', 'downlink', 'rtt'].forEach(function(name) {
                    populateNetworkInfo(name, connection, networkInfo);
                });
            }
            var perfData = {
                url: location.href,
                portal: 5274572,
                content: 57406541340,
                group: -1,
                connection: networkInfo,
                timing: performance.timing
            };
            xhr.send(JSON.stringify(perfData));
        }, 3000);  // Execute this 3 seconds after onload.
    });
})();
</script>

<script src="../../cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="../../cdnjs.cloudflare.com/ajax/libs/jquery-migrate/3.3.1/jquery-migrate.min.js"></script>

      <script id="__ada" data-handle="betterment-cx" src="../../static.ada.support/embed2.js" data-lazy=""></script>
    
<script src="../hs-fs/hub/5274572/hub_generated/template_assets/57001203564/1664461384184/betterment-theme/resources/btTrackingInit.min.js"></script>
<script src="../hs-fs/hub/5274572/hub_generated/template_assets/49666399874/1664461384009/betterment-theme/js/main.min.js"></script>
<script>
var hsVars = hsVars || {}; hsVars['language'] = 'en';
</script>

<script src="../hs/hsstatic/cos-i18n/static-1.53/bundles/project.js"></script>
<script src="../hs-fs/hub/5274572/hub_generated/template_assets/54140855575/1646258612663/betterment-theme/js/custom-scripts/navigation.min.js"></script>
<script src="../hs-fs/hub/5274572/hub_generated/module_assets/64614019605/1664467640221/module_64614019605_toast_banner_global.min.js"></script>


<script>
   $(".copy-clip-container").click(function() {
      let clipContainer = $(this);
      $(clipContainer).find('.copy-clip-confirmation').removeClass('copy-clip-confirmation--animate');
      navigator.clipboard.writeText('delayed-resilient-background-jobs-on-rails.html').then(
      function() 
         { 
            $(clipContainer).find('.copy-clip-confirmation').addClass('copy-clip-confirmation--animate');
         }
      );
   });

</script>

<script src="../hs-fs/hub/5274572/hub_generated/template_assets/57077355813/1659471603755/betterment-theme/templates/engineering_blog/blog.min.js"></script>

<!-- Start of HubSpot Analytics Code -->
<script type="text/javascript">
var _hsq = _hsq || [];
_hsq.push(["setContentType", "blog-post"]);
_hsq.push(["setCanonicalUrl", "https:\/\/www.betterment.com\/engineering\/delayed-resilient-background-jobs-on-rails"]);
_hsq.push(["setPageId", "57406541340"]);
_hsq.push(["setContentMetadata", {
    "contentPageId": 57406541340,
    "legacyPageId": "57406541340",
    "contentFolderId": null,
    "contentGroupId": 57138234906,
    "abTestId": null,
    "languageVariantId": 57406541340,
    "languageCode": "en",
    
}]);
</script>

<script type="text/javascript" id="hs-script-loader" async defer src="../hs/scriptloader/5274572.js"></script>
<!-- End of HubSpot Analytics Code -->


<script type="text/javascript">
var hsVars = {
    ticks: 1664470795868,
    page_id: 57406541340,
    
    content_group_id: 57138234906,
    portal_id: 5274572,
    app_hs_base_url: "https://app.hubspot.com",
    cp_hs_base_url: "https://cp.hubspot.com",
    language: "en",
    analytics_page_type: "blog-post",
    analytics_page_id: "57406541340",
    category_id: 3,
    folder_id: 0,
    is_hubspot_user: false
}
</script>


<script defer src="../hs/hsstatic/HubspotToolsMenu/static-1.138/js/index.js"></script>



<div id="fb-root"></div>
 <script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "../../connect.facebook.net/en_GB/all.js#xfbml=1&status=0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="../../platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
 


  
</body>
<!-- Mirrored from www.betterment.com/engineering/delayed-resilient-background-jobs-on-rails by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 30 Sep 2022 12:43:45 GMT -->
</html>